<!doctype html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!--common style, js 파일 import-->
    <link href="style/commonStyle.css" rel="stylesheet" />
    <link href="style/detailPageStyle.css" rel="stylesheet" />
    <title>8Woårld-상세</title>

    

</head>

<body>

    <div class="main">
        <div class="header"> <img src="img/home.svg" class="home_icon" id="mainBtn" />
            <span>
                <div class="title">팀 원 정 보</div>
                <div class="description">informatoin</div>
            </span>
        </div>
        <div class="addCharacter" id="detailData">
            <div class="area1">
                <div class="topp" id="q1">
                    여기에 이미지 추가 나와야디는데
                </div>
            </div>
            <div class="area2" id="q2">
            </div>
        </div>
        <div class="button">
            <button class="c_button" id="admendBtn">수정</button>
            <button class="c_button" id="deleteBtn">삭제</button>
        </div>
    </div>

    <!-- MODAL   -->
    <div id="modalContainer" class="hidden">
        <div id="modalContent">
            <p>팀원을 삭제합니다.</p>
            <div class="modalFooter">
                <button class="c_button" id="modalCloseBtn">닫기</button>
                <button class="c_button" id="modalDeleteBtn">삭제</button>
            </div>
        </div>
    </div>

</body>

<script type="module">

    // Firebase SDK 라이브러리 가져오기
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { collection, addDoc, query, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getDocs, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";



    // Firebase 구성 정보 설정
    const firebaseConfig = {

        apiKey: "AIzaSyDBzg-CgJ_rurOKVL3QsX14yfRyat4fy6c",
        authDomain: "world-6960c.firebaseapp.com",
        projectId: "world-6960c",
        storageBucket: "world-6960c.appspot.com",
        messagingSenderId: "892743835529",
        appId: "1:892743835529:web:b4eef016af8ecfb8884b58"

    };


    // Firebase 인스턴스 초기화
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    //Modal 관련
    const deleteBtn = document.getElementById('deleteBtn');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modal = document.getElementById('modalContainer');

    deleteBtn.addEventListener('click', () => {
        modal.classList.remove('hidden');
    });

    modalCloseBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
    });


    //전체 데이터 가져오기  나중에 삭제
    let docs = await getDocs(collection(db, "user"));
    docs.forEach((doc) => {
        let row = doc.data();

        let blog_url = row['blog_url'];
        let character_image = row['character'];
        let comment = row['comment'];
        let github_url = row['github_url'];
        let mbti = row['mbti'];
        let name = row['name'];
        let image = row['image'];

    });

    // receivedData: url parameter 로 받아온 사용자 캐릭터 사진 문자열만 저장하기 위한 변수
    const receivedData = location.href.substring(location.href.indexOf('?') + 1);
    let userArray = []; // 받아온 정보와 비교를 위해 user 데이터를 모두 저장하는 변수
    let userData; // 클릭 된 유저의 정보를 저장하는 변수

    docs.forEach((doc) => {
        // db에 존재하는 데이터 Array로 저장
        userArray.push(doc.data());
    });


    // user 데이터 중에 이미지가 같은 유저의 데이터를 사용
    userArray.forEach((e) => {
        if (e['character_image'] === receivedData) {
            userData = e;
        }
    })



    // 이미지 노출 테스트
    var asd = document.getElementById('q1').innerHTML = `
      <img src="${userData.image}"/>
     `

    const ref = collection(db, "user");
    const q = query(ref, where("name", "==", userData.name));


    const querySnapshot = await getDocs(q);
    querySnapshot.forEach((doc) => {

        const rrow = doc.data();

        console.log(rrow);

        const character_image = rrow['character'];
        const comment = rrow['comment'];
        const github_url = rrow['github_url'];
        const mbti = rrow['mbti'];
        const name = rrow['name'];
        const image = rrow['image'];
        const blog_url = rrow['blog_url'];

        const data4 = `  <div class="area2a" >
                            <p class="content">이름<br>${name}</p><br>
                            <p class="content">MBTI<br>${mbti}</p><br>
                            <p class="content">한마디<br>${comment}</p>   
                        </div>
                        <div class="area2b" id="q2">
                              <a href="${github_url}"><img class="img-github" src="img/icon-github.png" alt="..." /></a>
                              <a href="${blog_url}"><img class="img-velog" src="img/icon-velog.png" alt=".." /></a>
                        </div>`
        $('#q2').append(data4);
    })

    //버튼 관련 이벤트
    $('#mainBtn').on('click', () => {
        window.location.href = "mainPage.html";
    });

    $('#admendBtn').on('click', () => {

    });


    $('#modalDeleteBtn').on('click', () => {

        var deleteName = userData.name;

        async function plzdelete() {
            await deleteDoc(doc(db, "user",deleteName));

        }

        const onDelete = async () => {
            await deleteDoc(doc(db, "user", deleteName)); 
        };

        window.location.href = "mainPage.html";

    });
</script>
</body>

</html>