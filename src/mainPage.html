<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!--common style, js 파일 import-->
    <link href="style/commonStyle.css" rel="stylesheet"/>
    <link href="style/mainPageStyle.css" rel="stylesheet"/>
    <title>8World</title>
</head>
<body>

<script type="module">
    // todo : 현재 페이지 js 파일 분리 작업

    // firebase 호출부
    import {initializeApp} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {getFirestore} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import {collection} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import {getDocs} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDBzg-CgJ_rurOKVL3QsX14yfRyat4fy6c",
        authDomain: "world-6960c.firebaseapp.com",
        projectId: "world-6960c",
        storageBucket: "world-6960c.appspot.com",
        messagingSenderId: "892743835529",
        appId: "1:892743835529:web:b4eef016af8ecfb8884b58"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const data = await getDocs(collection(db, "user"));
    let toastMessage = document.getElementById('toast_message');


    let userArray = []; // Firebase에서 받아온 데이터 Array로 저장
    let arrayCount = 0; // 현재 위치한 row 확인을 위한 변수
    let imageArray = []; // image data

    const leftArrow = document.getElementById('left_arrow');
    const rightArrow = document.getElementById('right_arrow');
    const characterImageId = document.getElementById('character_image');
    const imageMiddle = document.getElementById('image_middle');

    data.forEach((doc) => {
        // db에 존재하는 데이터 Array로 저장
        const docs = doc.data();

        userArray.push(Object(docs));
    });

    // 없는 사용자일 경우 발생할 사용자 에러 메시지
    const toastOn = () => {
        toastMessage.classList.add('active');
        setTimeout(function () {
            toastMessage.classList.remove('active');
        }, 1000);
    }

    // 이미지 클릭 시 이벤트
    const imageClickEvent = (arrayNum) => {
        if (imageArray[arrayNum] === "assets/images/pngwing.com.png") {
            toastOn();
        } else {
            characterImageId.addEventListener('click', (e) => {
                const target = e.target;

                // json 형식으로 클릭한 이미지 데이터 전송
                for(let i = 0; i < userArray.length; i++){
                    if (userArray[i]['character_image'] === target.currentSrc) {
                        localStorage.setItem('characterImage', JSON.stringify(userArray[i]));
                    }
                }
            })

            location.href = 'detailPage.html';
        }
    };

    // image tag html에 전달 하는 함수
    const imageArea = () => {
        imageArray = [];

        if (userArray.length) {
            if (userArray.length < 3) {
                for (let i = 0; i < 3; i++) {
                    if (i < userArray.length) {
                        imageArray.push(userArray[i].character_image);
                    } else {
                        imageArray.push("assets/images/pngwing.com.png");
                    }
                }
            } else {
                for (let i = 0; i < userArray.length; i++) {
                    imageArray.push(userArray[i]['character_image']);
                }
            }
        } else {
            for (let i = 0; i < 3; i++) {
                imageArray.push("assets/images/pngwing.com.png");
            }
        }

        const leftImageNum = arrayCount - 1 < 0 ? imageArray.length - 1 : arrayCount - 1;
        const rightImageNum = arrayCount + 1 >= imageArray.length ? 0 : arrayCount + 1;

        // 이미지 노출 html
        characterImageId.innerHTML = `
            <div class="image_area" id="image_area">
                <div calss="content">
                    <img src="${imageArray[leftImageNum - 1 < 0 ? imageArray.length - 1 : leftImageNum - 1]}" class="character_image"/>
                </div>
                <div calss="content">
                    <img src="${imageArray[leftImageNum]}" class="character_image image_left"/>
                </div>
                <div calss="content">
                    <img src="${imageArray[arrayCount]}" class="character_image image_middle" id="image_middle"/>
                </div>
                <div calss="content">
                    <img src="${imageArray[rightImageNum]}" class="character_image image_right"/>
                </div>
                <div calss="content">
                    <img src="${imageArray[rightImageNum + 1 >= imageArray.length ? 0 : rightImageNum + 1]}" class="character_image"/>
                </div>
            </div>
        `;

        // image click event
        $('.image_left').on('click', () => {
            imageClickEvent(leftImageNum);
        });
        $('.image_middle').on('click', () => {
            imageClickEvent(arrayCount);
        });
        $('.image_right').on('click', () => {
            imageClickEvent(rightImageNum);
        });
    }

    // 이미지 전환 시 현재 있는 이미지 개수를 넘지 않도록 조정하는 함수
    const changeImage = (moveCount) => {

        if (imageArray.length <= (arrayCount + moveCount)) {
            arrayCount = 0;
        } else if (0 > (arrayCount + moveCount)) {
            arrayCount = imageArray.length - 1;
        } else {
            arrayCount += moveCount;
        }

        setTimeout(() => {
            imageArea();
        }, 500);
    }

    // 이미지 이동 애니메이션
    const imageMoveAnimation = (direction) => {
        characterImageId.animate(
            [
                {transform: `translate(0, 0)`},
                {transform: `translate(` + direction + `350px, 0)`},
            ],
            {
                duration: 500,
            }
        );
        document.querySelector('.image_middle').classList.add('image_small');
    }

    // 이미지 이동 버튼 클릭 이벤트
    leftArrow.addEventListener('click', () => {
        changeImage(1);
        imageMoveAnimation('-');
        document.querySelector('.image_right').classList.add('image_big');
    });

    rightArrow.addEventListener('click', () => {
        changeImage(-1);
        imageMoveAnimation('+');
        document.querySelector('.image_left').classList.add('image_big');
    });

    //html DOM 생성 완료 후 바로 이미지 노출 되기 위한 코드
    $(document).ready(() => {
        imageArea();
    })
</script>

<div class="main">
    <div class="title">8 World</div>
    <div class="description">8조 8은 안으로 굽조 입니다!</div>
    <div class="slider">
        <button class="c_button c_button_m left_button" id="left_arrow"><</button>
        <div class="item_area">
            <span class="item" id="character_image"></span>
        </div>
        <button class="c_button_m c_button right_button" id="right_arrow">></button>
    </div>
    <button class="c_button c_button_m" onclick="location.href='addPage.html'">팀원 추가</button>
    <div id="toast_message">없는 사용자 입니다.</div>
</div>

</body>
</html>